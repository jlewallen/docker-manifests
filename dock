#!/usr/bin/python

import os
import optparse
import docker.client

from cloudvm.models import *
from urlparse import urlparse

class Options:
	def __init__(self, entries, args): 
		self.__dict__.update(entries)	
		self.manifest = args[0]

def get_docker():
	docker_url = urlparse("http://127.0.0.1:4243")
	return docker.Client(base_url = docker_url.geturl())

def get_options():
	parser = optparse.OptionParser()
	parser.add_option("--stop", action="store_true", dest="stop", default=False, help="stop instances")
	parser.add_option("--kill", action="store_true", dest="kill", default=False, help="kill instances")
	raw_options, args = parser.parse_args()
	if not args:
		exit("No manifest given.")
	return Options(vars(raw_options), args)

def main():
	options = get_options()
	docker = get_docker()

	if os.geteuid() != 0:
		exit("You need to have root privileges to run this script.\nPlease try again, this time using 'sudo'. Exiting.")

	manifest = Manifest(options.manifest)
	if options.stop:
		manifest.stop(docker)
	elif options.kill:
		manifest.kill(docker)
	else:
		manifest.provision(docker)
	manifest.save()

main()
