#!/usr/bin/python

import os
import optparse

from cloudvm.models import *

class Options:
	def __init__(self, entries, args): 
		self.__dict__.update(entries)	
		self.manifest = args[0]

def get_options():
	parser = optparse.OptionParser()
	parser.add_option("--stop", action="store_true", dest="stop", default=False, help="stop instances")
	parser.add_option("--kill", action="store_true", dest="kill", default=False, help="kill instances")
	raw_options, args = parser.parse_args()
	if not args:
		exit("No manifest given.")
	return Options(vars(raw_options), args)

def main():
	options = get_options()
	docker = Configuration.get_docker()

	if os.geteuid() != 0:
		exit("You need to have root privileges to run this script.\nPlease try again, this time using 'sudo'. Exiting.")

	state = State.load("dock.state")
	ctx = Context(docker, None, state)
	manifest = Manifest(options.manifest)

	if options.stop:
		manifest.stop(ctx)
	elif options.kill:
		manifest.kill(ctx)
	else:
		manifest.provision(ctx)

	manifest.save()
	state.save("dock.state")

main()
